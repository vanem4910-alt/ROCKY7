<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DPMods Admin - Final Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&family=JetBrains+Mono:wght[400]&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === GLOBAL VARIABLES (Purple Glass Theme) === */
        :root {
            --bg-color: #10051a;
            --glass: rgba(40, 10, 50, 0.7);
            --glass-border: rgba(187, 102, 255, 0.25);
            --primary: #bb66ff; 
            --text: #ffffff;
            --text-muted: #d1d1d1;
            --input-bg: rgba(255, 255, 255, 0.05);
            --button-bg: #2d1b36;
            --dropdown-bg: #1a0823;

            /* Status Colors */
            --c-expired: #ff4d4d;
            --c-warning: #ffbb33;
            --c-valid: #00c851;
            --c-lifetime: #f5f6fa;
            --c-duration: #33b5e5;

            --radius: 14px;
            --font: 'Poppins', sans-serif;
            --blur: blur(16px);
            --padding: 18px;
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 90% 10%, rgba(187, 102, 255, 0.1), transparent 40%),
                              radial-gradient(circle at 10% 90%, rgba(50, 20, 80, 0.4), transparent 40%);
            color: var(--text); font-family: var(--font); 
            margin: 0; padding-bottom: 90px;
            overflow-x: hidden;
            display: flex; flex-direction: column; min-height: 100vh;
        }

        /* --- LAYOUT --- */
        .app-main { display: flex; flex-grow: 1; width: 100%; }
        .tab-wrapper { flex-grow: 1; padding: 0; }
        .tab-content { display: none; padding: var(--padding); max-width: 900px; margin: 0 auto; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- HEADER --- */
        header { 
            position: sticky; top: 0; z-index: 100; 
            background: rgba(16, 5, 26, 0.9); backdrop-filter: var(--blur); 
            padding: var(--padding); border-bottom: 1px solid var(--glass-border);
        }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .brand { font-size: 1.3rem; font-weight: 600; display: flex; align-items: center; gap: 10px; letter-spacing: 0.5px; }
        .action-btn { width: 42px; height: 42px; border-radius: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .action-btn:active { transform: scale(0.95); }

        .search-wrap { display: flex; gap: 10px; height: 48px; }
        .search-box { flex: 1; background: var(--input-bg); border: 1px solid var(--glass-border); border-radius: 12px; display: flex; align-items: center; padding: 0 15px; }
        .search-box input { font-size: 0.95rem; background: none; border: none; color: white; flex: 1; outline: none; font-family: var(--font); margin-left: 10px; }
        
        .sort-btn { width: 110px; font-size: 0.85rem; position: relative; background: var(--input-bg); border: 1px solid var(--glass-border); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); gap: 6px; }
        .sort-dropdown { position: absolute; top: 55px; right: 0; width: 160px; background: #150520; border: 1px solid var(--glass-border); border-radius: 12px; overflow: hidden; display: none; z-index: 200; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .sort-opt { padding: 12px; font-size: 0.85rem; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .sort-opt:hover, .sort-opt.active { background: var(--primary); color: white; }

        /* --- CARDS --- */
        .glass-card { background: var(--glass); backdrop-filter: var(--blur); border: 1px solid var(--glass-border); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .card-head { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1.2px; color: var(--primary); font-weight: 700; border-bottom: 1px solid var(--glass-border); padding-bottom: 12px; margin-bottom: 18px; display: flex; align-items: center; gap: 8px; }

        /* --- KEY LIST ITEM --- */
        .key-item { 
            background: rgba(255, 255, 255, 0.03); 
            border: 1px solid var(--glass-border); 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 12px; 
            display: flex; justify-content: space-between; align-items: center; 
            transition: 0.2s; cursor: pointer; position: relative;
        }
        .key-item:hover { background: rgba(255, 255, 255, 0.06); transform: translateY(-2px); }
        
        .k-info h4 { font-size: 1rem; margin: 0 0 6px 0; display: flex; align-items: center; gap: 8px; font-family: 'JetBrains Mono', monospace; letter-spacing: -0.5px; }
        .k-tags { display: flex; gap: 6px; flex-wrap: wrap; }
        .tag { font-size: 0.7rem; padding: 4px 10px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: var(--text-muted); }
        
        .k-actions { display: flex; gap: 15px; }
        .k-actions i { font-size: 1.1rem; color: var(--text-muted); transition: 0.2s; }
        .k-actions i:hover { color: var(--primary); }

        .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; }
        .dot-expired { background: var(--c-expired); box-shadow: 0 0 8px var(--c-expired); }
        .dot-warning { background: var(--c-warning); box-shadow: 0 0 8px var(--c-warning); animation: pulse 1.5s infinite; }
        .dot-valid { background: var(--c-valid); box-shadow: 0 0 8px var(--c-valid); }
        .dot-lifetime { background: var(--c-lifetime); box-shadow: 0 0 8px var(--c-lifetime); }
        .dot-duration { background: var(--c-duration); box-shadow: 0 0 8px var(--c-duration); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* --- FORMS --- */
        .input-grp { margin-bottom: 15px; }
        .input-grp label { display: block; font-size: 0.8rem; margin-bottom: 6px; color: var(--text-muted); font-weight: 500; }
        .inp { 
            width: 100%; padding: 14px; font-size: 0.95rem; border-radius: 12px; 
            background: var(--input-bg); border: 1px solid var(--glass-border); 
            color: white; font-family: 'JetBrains Mono', monospace; 
            box-sizing: border-box; outline: none; transition: 0.3s;
        }
        .inp:focus { border-color: var(--primary); background: rgba(255,255,255,0.08); }
        
        select.inp { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 15px center; }
        select.inp option { background: var(--dropdown-bg); color: white; padding: 10px; }

        /* --- NAV & FAB --- */
        .navbar { position: fixed; bottom: 0; width: 100%; height: 70px; background: rgba(10, 5, 26, 0.95); backdrop-filter: blur(10px); border-top: 1px solid var(--glass-border); display: flex; justify-content: space-around; align-items: center; z-index: 900; }
        .nav-btn { text-align: center; color: var(--text-muted); font-size: 0.65rem; flex: 1; transition: 0.3s; cursor: pointer; }
        .nav-btn i { font-size: 1.2rem; display: block; margin-bottom: 4px; }
        .nav-btn.active { color: var(--primary); transform: translateY(-3px); }

        .sidebar { display: none; position: sticky; top: 0; width: 240px; padding: 20px 0; background: rgba(10, 5, 26, 0.8); border-right: 1px solid var(--glass-border); height: 100vh; }
        .side-btn { display: flex; align-items: center; padding: 16px 25px; color: var(--text-muted); cursor: pointer; transition: 0.2s; font-size: 0.95rem; gap: 15px; }
        .side-btn:hover, .side-btn.active { background: rgba(187, 102, 255, 0.15); color: var(--primary); border-left: 3px solid var(--primary); }

        @media (min-width: 900px) {
            body { padding-bottom: 0; }
            .navbar { display: none; }
            .sidebar { display: block; }
            .tab-wrapper { padding: 20px 40px; }
            .fab-stack { bottom: 30px; right: 30px; }
        }

        /* --- FAB & MODAL --- */
        .fab-stack { position: fixed; bottom: 90px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 950; }
        .fab { width: 56px; height: 56px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.4rem; color: white; border: none; cursor: pointer; background: var(--primary); box-shadow: 0 8px 20px rgba(0,0,0,0.5); transition: 0.3s; }
        .fab:active { transform: scale(0.9); }
        .fab-magic { background: linear-gradient(135deg, #bb66ff, #ff55a3); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 10000; }
        
        /* Animation for modal visibility */
        @keyframes modalPop { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        
        .modal-box { 
            background: #150520; width: 90%; max-width: 420px; padding: 30px; 
            border-radius: 24px; border: 1px solid var(--glass-border); 
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); max-height: 90vh; overflow-y: auto;
            animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        
        .modal-btn-row { display: flex; justify-content: flex-end; gap: 12px; margin-top: 25px; }
        .m-btn { padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; font-size: 0.9rem; }
        .m-save { background: var(--primary); color: white; }
        .m-close { background: rgba(255,255,255,0.1); color: var(--text-muted); }

        /* Loader & Toast */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 11000; display: none; justify-content: center; align-items: center; flex-direction: column; gap: 15px; color: var(--primary); }
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 12px 24px; border-radius: 50px; font-size: 0.9rem; font-weight: 500; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 11000; opacity: 0; transition: 0.3s; pointer-events: none; white-space: nowrap; }
    </style>
</head>
<body onload="initApp()">

    <div id="toast">Notification</div>
    <div id="loader"><i class="fas fa-circle-notch fa-spin fa-2x"></i><span>Syncing Data...</span></div>

    <datalist id="time-presets"><option value="1h"><option value="12h"><option value="1d"><option value="3d"><option value="1w"><option value="30d"><option value="lifetime"></datalist>

    <header>
        <div class="top-row">
            <div class="brand"><i class="fas fa-shield-halved"></i> DPMods Admin</div>
            <div class="action-btn" onclick="loadData()"><i class="fas fa-sync-alt"></i></div>
        </div>
        <div class="search-wrap">
            <div class="search-box">
                <i class="fas fa-search" style="opacity:0.5"></i>
                <input type="text" id="search" placeholder="Search keys..." oninput="renderKeys()">
            </div>
            <div class="sort-btn" onclick="toggleSort()">
                <i class="fas fa-filter"></i> <span id="sortLbl">Default</span>
                <div id="sortMenu" class="sort-dropdown">
                    <div class="sort-opt active" onclick="setSort('default', 'Default (Smart)')">Default (Smart)</div>
                    <div class="sort-opt" onclick="setSort('exp', 'Expiring Soon')">Expiring Soon</div>
                    <div class="sort-opt" onclick="setSort('az', 'Name A-Z')">Name A-Z</div>
                </div>
            </div>
        </div>
    </header>
    
    <div class="app-main">
        <nav class="sidebar">
            <div class="side-btn active" onclick="nav('keys', this)"><i class="fas fa-key"></i> Keys</div>
            <div class="side-btn" onclick="nav('config', this)"><i class="fas fa-cogs"></i> Config</div>
            <div class="side-btn" onclick="nav('security', this)"><i class="fas fa-shield-alt"></i> Security</div>
            <div class="side-btn" onclick="nav('ui', this)"><i class="fas fa-palette"></i> Appearance</div>
            <div class="side-btn" onclick="nav('promo', this)"><i class="fas fa-bullhorn"></i> Promo</div>
        </nav>

        <div class="tab-wrapper">
            <div id="tab-keys" class="tab-content active">
                <div id="keysList"></div>
            </div>

            <div id="tab-config" class="tab-content">
                <div class="glass-card">
                    <div class="card-head"><i class="fas fa-globe"></i> System Config</div>
                    <div style="display:flex; gap:10px;">
                        <div class="input-grp" style="flex:1"><label>Maintenance</label><select id="c_maint" class="inp select-styled"><option value="true">ON</option><option value="false">OFF</option></select></div>
                        <div class="input-grp" style="flex:1"><label>Silent Check</label><select id="c_silent" class="inp select-styled"><option value="true">ON</option><option value="false">OFF</option></select></div>
                    </div>
                    <div class="input-grp"><label>Admin Contact URL</label><input type="text" id="c_admin" class="inp"></div>
                    <div class="input-grp"><label>Timezone</label><input type="text" id="c_tz" class="inp"></div>
                </div>
                <div class="glass-card">
                    <div class="card-head"><i class="fab fa-telegram"></i> Telegram Integration</div>
                    <div class="input-grp"><label>Bot Token</label><input type="text" id="c_bot" class="inp"></div>
                    <div class="input-grp"><label>Chat ID</label><input type="text" id="c_chat" class="inp"></div>
                    <div class="input-grp"><label>Broadcast Active</label><select id="c_bc_active" class="inp select-styled"><option value="true">YES</option><option value="false">NO</option></select></div>
                    <div class="input-grp"><label>Broadcast Msg</label><textarea id="c_bc_msg" class="inp" rows="2"></textarea></div>
                    <div class="modal-btn-row"><button class="m-btn m-save" onclick="saveAllData()">Save Config</button></div>
                </div>
            </div>

            <div id="tab-security" class="tab-content">
                <div class="glass-card">
                    <div class="card-head"><i class="fas fa-lock"></i> Security</div>
                    <div class="input-grp"><label>Package Name</label><input type="text" id="s_pkg" class="inp"></div>
                    <div class="input-grp"><label>Kill on Mismatch?</label><select id="s_kill" class="inp select-styled"><option value="true">YES</option><option value="false">NO</option></select></div>
                </div>
                <div class="glass-card">
                    <div class="card-head"><i class="fas fa-ban"></i> Device Blacklist</div>
                    <div class="input-grp"><label>One ID per line</label><textarea id="s_bl" class="inp" rows="6"></textarea></div>
                    <div class="modal-btn-row"><button class="m-btn m-save" onclick="saveAllData()">Save Security</button></div>
                </div>
            </div>

            <div id="tab-ui" class="tab-content">
                <div class="glass-card">
                    <div class="card-head"><i class="fas fa-paint-brush"></i> Login UI</div>
                    <div class="input-grp"><label>Title</label><input type="text" id="u_title" class="inp"></div>
                    <div class="input-grp"><label>Subtitle</label><input type="text" id="u_sub" class="inp"></div>
                    <div style="display:flex; gap:10px">
                        <div class="input-grp" style="flex:1"><label>Login Btn</label><input type="text" id="u_lbtn" class="inp"></div>
                        <div class="input-grp" style="flex:1"><label>Get Key Btn</label><input type="text" id="u_abtn" class="inp"></div>
                    </div>
                    <div class="input-grp"><label>Error Title</label><input type="text" id="ui_errorTitle" class="inp"></div>
                    <div class="input-grp"><label>Error Subtitle</label><input type="text" id="ui_errorSub" class="inp"></div>
                </div>

                <div class="glass-card">
                    <div class="card-head"><i class="fas fa-palette"></i> Custom Theme</div>
                    <div class="input-grp"><label>Use Custom Colors?</label>
                        <select id="theme_useCustom" class="inp select-styled"><option value="true">YES</option><option value="false">NO</option></select>
                    </div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <div class="input-grp" style="flex:1"><label>Background</label><input type="color" id="theme_background" class="inp" style="height:45px;"></div>
                        <div class="input-grp" style="flex:1"><label>Accent</label><input type="color" id="theme_accent" class="inp" style="height:45px;"></div>
                        <div class="input-grp" style="flex:1"><label>Text</label><input type="color" id="theme_text" class="inp" style="height:45px;"></div>
                        <div class="input-grp" style="flex:1"><label>Sub Text</label><input type="color" id="theme_subText" class="inp" style="height:45px;"></div>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="card-head"><i class="fas fa-star"></i> Particles & Socials</div>
                    <div class="input-grp"><label>Enable Particles</label>
                        <select id="ui_enableParticles" class="inp select-styled"><option value="true">YES</option><option value="false">NO</option></select>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <div class="input-group" style="flex:1"><label>Particle 1</label><input type="color" id="ui_particleColor1" class="inp" style="height:45px;"></div>
                        <div class="input-group" style="flex:1"><label>Particle 2</label><input type="color" id="ui_particleColor2" class="inp" style="height:45px;"></div>
                    </div>

                    <hr style="border-color:var(--glass-border); margin: 20px 0;">
                    
                    <div style="display:flex; gap:10px;">
                        <div class="input-group" style="flex:1"><label>Show TG</label><select id="soc_telegram" class="inp select-styled"><option value="true">YES</option><option value="false">NO</option></select></div>
                        <div class="input-group" style="flex:1"><label>Show YT</label><select id="soc_youtube" class="inp select-styled"><option value="true">YES</option><option value="false">NO</option></select></div>
                        <div class="input-group" style="flex:1"><label>Show IG</label><select id="soc_instagram" class="inp select-styled"><option value="true">YES</option><option value="false">NO</option></select></div>
                    </div>
                    
                    <div class="input-grp"><label>Telegram URL</label><input type="text" id="l_tg" class="inp"></div>
                    <div class="input-grp"><label>YouTube URL</label><input type="text" id="l_yt" class="inp"></div>
                    <div class="input-grp"><label>Instagram URL</label><input type="text" id="l_ig" class="inp"></div>
                    
                    <div class="modal-btn-row"><button class="m-btn m-save" onclick="saveAllData()">Save UI</button></div>
                </div>
            </div>

            <div id="tab-promo" class="tab-content">
                <div class="glass-card">
                    <div class="card-head"><i class="fas fa-bullhorn"></i> Promo & Updates</div>
                    <div class="input-grp"><label>Promo Active</label><select id="p_en" class="inp select-styled"><option value="true">YES</option><option value="false">NO</option></select></div>
                    <div class="input-grp"><label>Promo Text</label><input type="text" id="p_txt" class="inp"></div>
                    <div class="input-grp"><label>Promo Link</label><input type="text" id="p_url" class="inp"></div>
                    <hr style="border-color:var(--glass-border); margin: 20px 0;">
                    <div style="display:flex; gap:10px">
                        <div class="input-grp" style="flex:1"><label>Update Avail</label><select id="up_avail" class="inp select-styled"><option value="true">YES</option><option value="false">NO</option></select></div>
                        <div class="input-grp" style="flex:1"><label>Force Update</label><select id="up_force" class="inp select-styled"><option value="true">YES</option><option value="false">NO</option></select></div>
                    </div>
                    <div class="input-grp"><label>New Version</label><input type="text" id="up_ver" class="inp"></div>
                    <div class="input-grp"><label>APK URL</label><input type="text" id="up_url" class="inp"></div>
                    <div class="modal-btn-row"><button class="m-btn m-save" onclick="saveAllData()">Save Promo</button></div>
                </div>
            </div>
        </div>
    </div>

    <nav class="navbar">
        <div class="nav-btn active" onclick="nav('keys', this)"><i class="fas fa-key"></i>Keys</div>
        <div class="nav-btn" onclick="nav('config', this)"><i class="fas fa-cogs"></i>Config</div>
        <div class="nav-btn" onclick="nav('security', this)"><i class="fas fa-shield-alt"></i>Sec</div>
        <div class="nav-btn" onclick="nav('ui', this)"><i class="fas fa-palette"></i>UI</div>
        <div class="nav-btn" onclick="nav('promo', this)"><i class="fas fa-bullhorn"></i>Promo</div>
    </nav>

    <div class="fab-stack">
        <button class="fab fab-magic" onclick="openGenModal()"><i class="fas fa-magic"></i></button>
        <button class="fab" onclick="openKeyModal()"><i class="fas fa-plus"></i></button>
    </div>

    <div id="keyModal" class="modal-overlay">
        <div class="modal-box">
            <div class="card-head">Key Manager</div>
            <div class="input-grp"><label>Key Name</label><input type="text" id="mk_name" class="inp" placeholder="KEY_NAME"></div>
            <div class="input-grp"><label>Type</label>
                <select id="mk_type" class="inp select-styled" onchange="toggleMode('mk')">
                    <option value="duration">Duration</option>
                    <option value="date">Date</option>
                    <option value="lifetime">Lifetime</option>
                </select>
            </div>
            <div class="input-grp" id="mk_val_grp"><label>Expiry (1d, 30d or YYYY-MM-DD)</label><input type="text" id="mk_val" class="inp" list="time-presets"></div>
            <div class="input-grp"><label>Interval</label><input type="text" id="mk_int" class="inp" placeholder="1d"></div>
            <div class="input-grp"><label>Devices (Comma/Newline sep)</label><textarea id="mk_dev" class="inp" rows="2"></textarea></div>
            <div class="input-grp"><label>Notify User?</label><select id="mk_notify" class="inp select-styled"><option value="true">YES</option><option value="false">NO</option></select></div>
            <div class="input-grp"><label>Toast Message</label><input type="text" id="mk_toast" class="inp"></div>
            <div class="modal-btn-row">
                <button class="m-btn m-close" onclick="closeM('keyModal')">Cancel</button>
                <button class="m-btn m-save" onclick="saveKey()">Save Key</button>
            </div>
        </div>
    </div>

    <div id="genModal" class="modal-overlay">
        <div class="modal-box">
            <div class="card-head">Key Generator</div>
            <div class="input-grp"><label>Prefix</label><input type="text" id="gk_pre" class="inp" placeholder="VIP"></div>
            <div class="input-grp"><label>Amount</label><input type="number" id="gk_amt" class="inp" value="1" min="1"></div>
            <div class="input-grp"><label>Type</label>
                <select id="gk_type" class="inp select-styled" onchange="toggleMode('gk')">
                    <option value="duration">Duration</option>
                    <option value="date">Date</option>
                    <option value="lifetime">Lifetime</option>
                </select>
            </div>
            <div class="input-grp" id="gk_val_grp"><label>Expiry</label><input type="text" id="gk_val" class="inp" list="time-presets" value="1d"></div>
            <div class="input-grp"><label>Interval</label><input type="text" id="gk_int" class="inp" placeholder="1d"></div>
            <div class="input-grp"><label>Shared Device List</label><input type="text" id="gk_dev" class="inp" placeholder="ID1, ID2..."></div>
            <div class="input-grp"><label>Notify?</label><select id="gk_notify" class="inp select-styled"><option value="true">YES</option><option value="false">NO</option></select></div>
            <div class="input-grp"><label>Toast</label><input type="text" id="gk_toast" class="inp"></div>
            <div class="modal-btn-row">
                <button class="m-btn m-close" onclick="closeM('genModal')">Close</button>
                <button class="m-btn m-save" onclick="generate()">Generate</button>
            </div>
        </div>
    </div>

    <script>
        // === CONFIGURATION (UPDATED) ===
        const REPO = "DPModsYT/animkeylogspanel";
        const TOKEN = "glpat-fusK_SUBSCRIBE_DPMods.01.1212qmsvp"; 
        const FILE = "Key.json";
        const BRANCH = "main";
        const API = `https://gitlab.com/api/v4/projects/${encodeURIComponent(REPO)}/repository/files/${encodeURIComponent(FILE)}`;
        
        // A very distant future timestamp (used to push Lifetime/Duration keys to the bottom of the expiry sort)
        const LIFETIME_TS = 99999999999999; 

        let DATA = { config:{}, security:{}, ui:{}, theme:{}, social_links:{}, promo:{}, update:{}, blacklist:[], keys:{} };
        let EDIT_ID = null;
        let SORT = 'default';

        function toast(msg, err=false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.background = err ? '#ff4d4d' : '#bb66ff';
            t.style.opacity = 1; t.style.transform = 'translate(-50%, -5px)';
            setTimeout(()=> { t.style.opacity = 0; t.style.transform = 'translate(-50%, 0)'; }, 3000);
        }

        // === API LOGIC ===
        async function loadData() {
            document.getElementById('loader').style.display = 'flex';
            try {
                const r = await fetch(`${API}?ref=${BRANCH}`, { headers: { 'Private-Token': TOKEN } });
                if(r.status === 404) {
                    toast("Key.json not found. Starting fresh.", true);
                    document.getElementById('loader').style.display = 'none';
                    return;
                }
                if(!r.ok) throw new Error(r.statusText || "Failed to connect to GitLab (Check Token)");
                
                const j = await r.json();
                const content = JSON.parse(atob(j.content));
                
                DATA = content;
                if(!DATA.keys) DATA.keys = {};
                if(!DATA.blacklist) DATA.blacklist = [];
                
                renderAll();
                toast("Data Synced Successfully");
            } catch(e) {
                console.error(e);
                toast("Load Error: " + e.message, true);
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function saveAllData() {
            // CONFIG
            if(!DATA.config) DATA.config = {};
            DATA.config.maintenance = document.getElementById('c_maint').value === 'true';
            DATA.config.silentCheck = document.getElementById('c_silent').value === 'true';
            DATA.config.timezone = document.getElementById('c_tz').value;
            DATA.config.adminUrl = document.getElementById('c_admin').value;
            DATA.config.tgBotToken = document.getElementById('c_bot').value;
            DATA.config.tgChatId = document.getElementById('c_chat').value;
            DATA.config.broadcastEnabled = document.getElementById('c_bc_active').value === 'true';
            DATA.config.broadcastMessage = document.getElementById('c_bc_msg').value;

            // SECURITY
            if(!DATA.security) DATA.security = {};
            DATA.security.packageName = document.getElementById('s_pkg').value;
            DATA.security.killOnMismatch = document.getElementById('s_kill').value === 'true';
            const bl = document.getElementById('s_bl').value.trim();
            DATA.blacklist = bl ? bl.split('\n').map(x=>x.trim()).filter(x=>x) : [];

            // UI
            if(!DATA.ui) DATA.ui = {};
            DATA.ui.title = document.getElementById('u_title').value;
            DATA.ui.subtitle = document.getElementById('u_sub').value;
            DATA.ui.loginBtn = document.getElementById('u_lbtn').value;
            DATA.ui.adminBtn = document.getElementById('u_abtn').value;
            DATA.ui.errorTitle = document.getElementById('ui_errorTitle').value;
            DATA.ui.errorSub = document.getElementById('ui_errorSub').value;
            DATA.ui.enableParticles = document.getElementById('ui_enableParticles').value === 'true';
            DATA.ui.particleColor1 = document.getElementById('ui_particleColor1').value;
            DATA.ui.particleColor2 = document.getElementById('ui_particleColor2').value;
            
            if(!DATA.ui.socials) DATA.ui.socials = {};
            DATA.ui.socials.telegram = document.getElementById('soc_telegram').value === 'true';
            DATA.ui.socials.youtube = document.getElementById('soc_youtube').value === 'true';
            DATA.ui.socials.instagram = document.getElementById('soc_instagram').value === 'true';

            // THEME
            if(!DATA.theme) DATA.theme = {};
            DATA.theme.useCustom = document.getElementById('theme_useCustom').value === 'true';
            DATA.theme.background = document.getElementById('theme_background').value;
            DATA.theme.accent = document.getElementById('theme_accent').value;
            DATA.theme.text = document.getElementById('theme_text').value;
            DATA.theme.subText = document.getElementById('theme_subText').value;

            // LINKS
            if(!DATA.social_links) DATA.social_links = {};
            DATA.social_links.telegram = document.getElementById('l_tg').value;
            DATA.social_links.youtube = document.getElementById('l_yt').value;
            DATA.social_links.instagram = document.getElementById('l_ig').value;

            // PROMO
            if(!DATA.promo) DATA.promo = {};
            DATA.promo.enabled = document.getElementById('p_en').value === 'true';
            DATA.promo.text = document.getElementById('p_txt').value;
            DATA.promo.url = document.getElementById('p_url').value;

            // UPDATE
            if(!DATA.update) DATA.update = {};
            DATA.update.available = document.getElementById('up_avail').value === 'true';
            DATA.update.force = document.getElementById('up_force').value === 'true';
            DATA.update.version = document.getElementById('up_ver').value;
            DATA.update.url = document.getElementById('up_url').value;


            // Push to GitLab
            document.getElementById('loader').style.display = 'flex';
            try {
                const payload = {
                    branch: BRANCH,
                    commit_message: "Update from Admin Panel",
                    encoding: "base64",
                    content: btoa(JSON.stringify(DATA, null, 2))
                };
                
                const r = await fetch(API, {
                    method: 'PUT',
                    headers: { 'Private-Token': TOKEN, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if(!r.ok) throw new Error(r.statusText || "GitLab API Error");
                toast("Changes Saved to GitLab!");
            } catch(e) {
                console.error(e);
                toast("Save Failed: " + e.message, true);
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        // === KEY HELPERS ===

        function getExpiryTimestamp(d) {
            // Only 'date' type keys have a definite expiry date for sorting purposes
            if (d.type !== 'date' || !d.value) return LIFETIME_TS;

            // Date keys return their timestamp (earlier date = lower timestamp)
            const expiry = new Date(d.value).getTime();
            
            // If the date is invalid, treat as lifetime for safety
            return isNaN(expiry) ? LIFETIME_TS : expiry;
        }

        function getStatusDot(d) {
            if(d.type === 'lifetime') return 'dot-lifetime';
            if(d.type === 'duration') return 'dot-duration';
            
            // Date Check
            if(d.type === 'date' && d.value) {
                const exp = new Date(d.value).getTime();
                const now = Date.now();
                if(isNaN(exp)) return 'dot-valid'; // Treat invalid dates as valid by default
                if(exp < now) return 'dot-expired'; // Expired
                if(exp - now < 86400000 * 7) return 'dot-warning'; // Warning (less than 7 days)
                return 'dot-valid'; // Valid
            }
            return 'dot-valid';
        }

        // === KEY CRUD & RENDERERS ===

        function renderAll() {
            renderKeys();
            
            // CONFIG
            const c = DATA.config || {};
            document.getElementById('c_maint').value = (c.maintenance===true).toString();
            document.getElementById('c_silent').value = (c.silentCheck!==false).toString();
            document.getElementById('c_tz').value = c.timezone || '';
            document.getElementById('c_admin').value = c.adminUrl || '';
            document.getElementById('c_bot').value = c.tgBotToken || '';
            document.getElementById('c_chat').value = c.tgChatId || '';
            document.getElementById('c_bc_active').value = (c.broadcastEnabled===true).toString();
            document.getElementById('c_bc_msg').value = c.broadcastMessage || '';

            // SECURITY
            const s = DATA.security || {};
            document.getElementById('s_pkg').value = s.packageName || '';
            document.getElementById('s_kill').value = (s.killOnMismatch===true).toString();
            document.getElementById('s_bl').value = (DATA.blacklist || []).join('\n');

            // UI
            const u = DATA.ui || {};
            document.getElementById('u_title').value = u.title || '';
            document.getElementById('u_sub').value = u.subtitle || '';
            document.getElementById('u_lbtn').value = u.loginBtn || '';
            document.getElementById('u_abtn').value = u.adminBtn || '';
            document.getElementById('ui_errorTitle').value = u.errorTitle || '';
            document.getElementById('ui_errorSub').value = u.errorSub || '';
            document.getElementById('ui_enableParticles').value = (u.enableParticles===true).toString();
            document.getElementById('ui_particleColor1').value = u.particleColor1 || '#ff00ea'; // Defaulted to common value
            document.getElementById('ui_particleColor2').value = u.particleColor2 || '#0000ff'; // Defaulted to common value
            
            const soc = u.socials || {};
            document.getElementById('soc_telegram').value = (soc.telegram!==false).toString();
            document.getElementById('soc_youtube').value = (soc.youtube!==false).toString();
            document.getElementById('soc_instagram').value = (soc.instagram!==false).toString();

            // THEME
            const t = DATA.theme || {};
            document.getElementById('theme_useCustom').value = (t.useCustom===true).toString();
            document.getElementById('theme_background').value = t.background || '#000000';
            document.getElementById('theme_accent').value = t.accent || '#bb66ff';
            document.getElementById('theme_text').value = t.text || '#ffffff';
            document.getElementById('theme_subText').value = t.subText || '#d1d1d1';

            // LINKS
            const l = DATA.social_links || {};
            document.getElementById('l_tg').value = l.telegram || '';
            document.getElementById('l_yt').value = l.youtube || '';
            document.getElementById('l_ig').value = l.instagram || '';

            // PROMO
            const p = DATA.promo || {};
            document.getElementById('p_en').value = (p.enabled===true).toString();
            document.getElementById('p_txt').value = p.text || '';
            document.getElementById('p_url').value = p.url || '';

            // UPDATE
            const up = DATA.update || {};
            document.getElementById('up_avail').value = (up.available===true).toString();
            document.getElementById('up_force').value = (up.force===true).toString();
            document.getElementById('up_ver').value = up.version || '';
            document.getElementById('up_url').value = up.url || '';
        }
        
        function renderKeys() {
            const list = document.getElementById('keysList');
            list.innerHTML = '';
            const query = document.getElementById('search').value.toLowerCase();
            
            let keys = Object.keys(DATA.keys).filter(k => k.toLowerCase().includes(query));
            
            // --- Advanced Sorting Logic ---
            keys.sort((a, b) => {
                const keyA = DATA.keys[a];
                const keyB = DATA.keys[b];

                if (SORT === 'az') {
                    return a.localeCompare(b); // Alphabetical A-Z
                }

                // For 'default' and 'exp' sort, prioritize expiry time
                const expiryA = getExpiryTimestamp(keyA);
                const expiryB = getExpiryTimestamp(keyB);

                // Lower timestamp means sooner expiry (Expired=lowest, Warning=next, Valid=higher, Lifetime=Highest/LIFETIME_TS)
                if (expiryA !== expiryB) {
                    return expiryA - expiryB;
                }

                // Secondary sort: Alphabetical for keys with the same expiry (e.g., all lifetime keys)
                return a.localeCompare(b);
            });

            if(keys.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:40px; opacity:0.5">No Keys Found</div>`;
                return;
            }

            keys.forEach(k => {
                const d = DATA.keys[k];
                const dot = getStatusDot(d);
                const devices = d.devices ? `<span class="tag"><i class="fas fa-mobile"></i> ${d.devices.length}</span>` : '';
                
                list.innerHTML += `
                <div class="key-item" onclick="copy('${k}')">
                    <div class="k-info">
                        <h4><span class="dot ${dot}"></span> ${k}</h4>
                        <div class="k-tags">
                            <span class="tag">${d.type.toUpperCase()}</span>
                            <span class="tag">${d.value || 'âˆž'}</span>
                            ${devices}
                        </div>
                    </div>
                    <div class="k-actions">
                        <i class="fas fa-pen" onclick="event.stopPropagation(); edit('${k}')"></i>
                        <i class="fas fa-trash" onclick="event.stopPropagation(); delKey('${k}')"></i>
                    </div>
                </div>`;
            });
        }

        // --- UTILITY FUNCTIONS ---

        function saveKey() {
            const name = document.getElementById('mk_name').value.trim();
            if(!name) return toast("Key Name Required", true);

            const type = document.getElementById('mk_type').value;
            const val = document.getElementById('mk_val').value.trim();
            const int = document.getElementById('mk_int').value.trim() || '1d';
            const devRaw = document.getElementById('mk_dev').value.trim();
            const notify = document.getElementById('mk_notify').value === 'true';
            const tst = document.getElementById('mk_toast').value.trim();

            const keyObj = { type: type, interval: int, notify: notify };
            if(type !== 'lifetime') keyObj.value = val;
            if(tst) keyObj.toast = tst;
            if(devRaw) keyObj.devices = devRaw.split(/[\n,]+/).map(x=>x.trim()).filter(x=>x);

            if(EDIT_ID && EDIT_ID !== name) delete DATA.keys[EDIT_ID];
            
            DATA.keys[name] = keyObj;
            closeM('keyModal');
            renderKeys();
            saveAllData();
        }

        function generate() {
            const prefix = document.getElementById('gk_pre').value.trim().toUpperCase();
            const amount = parseInt(document.getElementById('gk_amt').value) || 1;
            const type = document.getElementById('gk_type').value;
            const val = document.getElementById('gk_val').value.trim();
            const int = document.getElementById('gk_int').value.trim() || '1d';
            const devRaw = document.getElementById('gk_dev').value.trim();
            const notify = document.getElementById('gk_notify').value === 'true';
            const tst = document.getElementById('gk_toast').value.trim();
            
            const base = { type: type, interval: int, notify: notify };
            if(type !== 'lifetime') base.value = val;
            if(tst) base.toast = tst;
            if(devRaw) base.devices = devRaw.split(',').map(x=>x.trim()).filter(x=>x);

            for(let i=0; i<amount; i++) {
                const rand = Math.random().toString(36).substring(2,6).toUpperCase();
                const name = prefix ? `${prefix}_${rand}` : `KEY_${rand}`;
                DATA.keys[name] = JSON.parse(JSON.stringify(base));
            }
            
            closeM('genModal');
            renderKeys();
            saveAllData();
        }

        function delKey(k) {
            if(confirm('Delete ' + k + '?')) {
                delete DATA.keys[k];
                renderKeys();
                saveAllData();
            }
        }

        function copy(txt) { navigator.clipboard.writeText(txt); toast('Copied!'); }
        
        function edit(k) {
            EDIT_ID = k;
            const d = DATA.keys[k];
            document.getElementById('mk_name').value = k;
            document.getElementById('mk_name').disabled = true; 
            document.getElementById('mk_type').value = d.type;
            document.getElementById('mk_val').value = d.value || '';
            document.getElementById('mk_int').value = d.interval || '1d';
            document.getElementById('mk_dev').value = (d.devices || []).join('\n');
            document.getElementById('mk_notify').value = (d.notify!==false).toString();
            document.getElementById('mk_toast').value = d.toast || '';
            toggleMode('mk');
            document.getElementById('keyModal').style.display = 'flex';
        }

        function openKeyModal() {
            EDIT_ID = null;
            document.getElementById('mk_name').value = '';
            document.getElementById('mk_name').disabled = false;
            document.getElementById('mk_type').value = 'duration';
            document.getElementById('mk_val').value = '';
            document.getElementById('mk_int').value = '1d';
            document.getElementById('mk_dev').value = '';
            document.getElementById('mk_notify').value = 'true';
            document.getElementById('mk_toast').value = '';
            toggleMode('mk');
            document.getElementById('keyModal').style.display = 'flex';
        }

        function openGenModal() {
            document.getElementById('genModal').style.display = 'flex';
        }

        function closeM(id) { document.getElementById(id).style.display = 'none'; }
        function toggleMode(p) {
            const t = document.getElementById(p+'_type').value;
            document.getElementById(p+'_val_grp').style.display = t === 'lifetime' ? 'none' : 'block';
        }

        function nav(id, el) {
            document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            
            document.querySelectorAll('.nav-btn, .side-btn').forEach(x=>x.classList.remove('active'));
            
            const side = document.querySelector(`.side-btn[onclick*="'${id}'"]`);
            const bot = document.querySelector(`.nav-btn[onclick*="'${id}'"]`);
            if(side) side.classList.add('active');
            if(bot) bot.classList.add('active');
        }

        function toggleSort() {
            const m = document.getElementById('sortMenu');
            m.style.display = m.style.display === 'block' ? 'none' : 'block';
        }
        
        function setSort(v, t) {
            SORT = v;
            document.getElementById('sortLbl').textContent = t;
            toggleSort();
            renderKeys();
        }

        function initApp() {
            loadData();
        }
    </script>
</body>
</html>